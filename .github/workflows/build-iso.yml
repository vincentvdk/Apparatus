---
name: build-apparatus-iso
on:
  workflow_dispatch:
  workflow_run:
    workflows: ["build-apparatus-os"]
    types:
      - completed

env:
  IMAGE_NAME: "apparatus-os"
  IMAGE_REGISTRY: "ghcr.io/${{ github.repository_owner }}"

jobs:
  build_iso:
    name: Build ISO
    runs-on: ubuntu-24.04
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    permissions:
      contents: write
      packages: read

    steps:
      - name: Free up disk space
        run: |
          df -h
          # Remove large unused tools (~28GB total)
          sudo rm -rf /usr/local/aws-sam-cli || :
          sudo rm -rf /usr/local/julia* || :
          sudo rm -rf /usr/local/bin/kubectl /usr/local/bin/terraform /usr/local/bin/helm /usr/local/bin/pulumi* || :
          sudo rm -rf /usr/local/share/chromium /usr/local/share/powershell || :
          sudo rm -rf /usr/local/lib/android /usr/local/lib/heroku /usr/local/lib/node_modules || :
          sudo rm -rf /opt/az /opt/microsoft /opt/google /opt/pipx || :
          sudo rm -rf /opt/hostedtoolcache/CodeQL /opt/hostedtoolcache/go /opt/hostedtoolcache/PyPy /opt/hostedtoolcache/node || :
          sudo rm -rf /usr/share/dotnet /usr/share/swift || :
          sudo rm -rf /opt/ghc || :
          sudo apt-get purge -y firefox google-chrome-stable microsoft-edge-stable || :
          sudo apt-get autoremove -y || :
          sudo docker system prune -af || :
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build ISO
        id: build
        uses: ublue-os/titanoboa@main
        with:
          image-ref: ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          builder-distro: fedora
          livesys: false

      - name: Generate release tag
        id: tag
        run: echo "tag=iso-$(date +%Y%m%d)" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Apparatus OS ISO (${{ steps.tag.outputs.tag }})
          body: |
            Apparatus OS installation ISO

            Built from container image: `${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest`

            ## Installation
            1. Download the ISO file below
            2. Write to USB with `dd` or Balena Etcher
            3. Boot and follow the Anaconda installer
          files: ${{ steps.build.outputs.iso-dest }}
          fail_on_unmatched_files: true
