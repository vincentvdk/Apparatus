---
name: build-apparatus-iso
on:
  workflow_dispatch:
  workflow_run:
    workflows: ["build-apparatus-os"]
    types:
      - completed

env:
  IMAGE_NAME: "apparatus-os"
  IMAGE_REGISTRY: "ghcr.io/${{ github.repository_owner }}"

jobs:
  build_iso:
    name: Build ISO
    runs-on: ubuntu-24.04
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    permissions:
      contents: read
      packages: read

    steps:
      - name: Free up disk space
        run: |
          df -h
          # Remove large unused tools (~28GB total)
          sudo rm -rf /usr/local/aws-sam-cli || :
          sudo rm -rf /usr/local/julia* || :
          sudo rm -rf /usr/local/bin/kubectl /usr/local/bin/terraform /usr/local/bin/helm /usr/local/bin/pulumi* || :
          sudo rm -rf /usr/local/share/chromium /usr/local/share/powershell || :
          sudo rm -rf /usr/local/lib/android /usr/local/lib/heroku /usr/local/lib/node_modules || :
          sudo rm -rf /opt/az /opt/microsoft /opt/google /opt/pipx || :
          sudo rm -rf /opt/hostedtoolcache/CodeQL /opt/hostedtoolcache/go /opt/hostedtoolcache/PyPy /opt/hostedtoolcache/node || :
          sudo rm -rf /usr/share/dotnet /usr/share/swift || :
          sudo rm -rf /opt/ghc || :
          sudo apt-get purge -y firefox google-chrome-stable microsoft-edge-stable || :
          sudo apt-get autoremove -y || :
          sudo docker system prune -af || :
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build ISO
        id: build
        uses: ublue-os/titanoboa@main
        with:
          image-ref: ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          container-image: ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          builder-distro: fedora
          livesys: false
          hook-post-rootfs: ${{ github.workspace }}/os/iso_files/configure_live_session.sh
          kargs: "systemd.show_status=1"

      - name: Upload ISO to Hetzner S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.HETZNER_S3_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.HETZNER_S3_SECRET_KEY }}
        run: |
          pip install awscli

          aws s3 cp "${{ steps.build.outputs.iso-dest }}" \
            s3://${{ secrets.HETZNER_S3_BUCKET }}/apparatus-os-latest.iso \
            --endpoint-url "https://${{ secrets.HETZNER_S3_ENDPOINT }}"

          echo "ISO uploaded successfully"
