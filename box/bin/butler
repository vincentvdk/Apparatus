#!/usr/bin/env zsh
#set -x

logo='
   _____                                          __
  /  _  \  ______  ______ _____  _______ _____  _/  |_  __ __  ______
 /  /_\  \ \____ \ \____ \\__  \ \_  __ \\__  \ \   __\|  |  \/  ___/
/    |    \|  |_> >|  |_> >/ __ \_|  | \/ / __ \_|  |  |  |  /\___ \
\____|__  /|   __/ |   __/(____  /|__|   (____  /|__|  |____//____  >
        \/ |__|    |__|        \/             \/                  \/

'

echo -e "$logo"

# Available options
OPTIONS=(
  "Init              - Initialize a new Apparatus box"
  "Manage Tools      - Install and manage tools"
  "Theme             - Select a theme"
  "Exit              - Exit butler"
)

# -- Main func
main() {
  while true; do
    local OPT=$(gum choose "${OPTIONS[@]}" --height 15 --header "Option:")
    local CHOICE=$(echo "$OPT" | awk -F ' {2,}' '{print $1}' | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g')

    case "${CHOICE}" in
      init)
        init
        ;;
      manage-tools)
        manage_tools_tui
        ;;
      theme)
        set_theme
        ;;
      exit|q|"")
        echo "Goodbye!"
        return
        ;;
    esac
  done
}

# -- Manage tools TUI (Bubbletea)
manage_tools_tui() {
  if command -v butler-tools &>/dev/null; then
    butler-tools
  else
    echo '{{ Color "1" "butler-tools not installed" }}' | gum format -t template
    echo "The enhanced TUI requires the butler-tools binary."
    echo ""
    echo "Press any key to continue..."
    read -k 1
  fi
}

# -- Run init script
init() {
  echo '{{ Bold "# Initialize Apparatus box" }}' | gum format -t template
  echo ""
  if gum confirm "Run initialization script?"; then
    /opt/bin/init.sh
    echo ""
    echo '{{ Color "2" "✓ Initialization complete" }}' | gum format -t template
  fi
  echo ""
  echo "Press any key to continue..."
  read -k 1
}


# -- Set theme
set_theme() {
  local THEMES_DIR="/usr/share/apparatus/themes"
  local HOST_HOME="$DISTROBOX_HOST_HOME"

  echo '{{ Bold "# Set theme" }}' | gum format -t template
  local CHOICE=$(gum choose \
    "catppuccin-mocha  - Dark theme" \
    "catppuccin-latte  - Light theme" \
    "Back              - Return to main menu" \
    --height 15 --header "Select theme:")

  local THEME=$(echo "$CHOICE" | awk -F ' {2,}' '{print $1}')

  case "$THEME" in
    catppuccin-mocha|catppuccin-latte)
      echo '{{ Bold "# Applying theme: " }}'"$THEME" | gum format -t template

      # Apply kitty theme
      distrobox-host-exec bash -c "[ -d '$HOST_HOME/.config/kitty' ] && ln -sf '$THEMES_DIR/$THEME/kitty.conf' '$HOST_HOME/.config/kitty/theme.conf'"

      # Apply waybar theme
      distrobox-host-exec bash -c "[ -d '$HOST_HOME/.config/waybar' ] && ln -sf '$THEMES_DIR/$THEME/waybar.css' '$HOST_HOME/.config/waybar/theme.css'"

      # Apply mako theme
      distrobox-host-exec bash -c "[ -d '$HOST_HOME/.config/mako' ] && ln -sf '$THEMES_DIR/$THEME/mako.conf' '$HOST_HOME/.config/mako/config'"

      # Apply hyprland theme
      distrobox-host-exec bash -c "[ -d '$HOST_HOME/.config/hypr' ] && ln -sf '$THEMES_DIR/$THEME/hyprland.conf' '$HOST_HOME/.config/hypr/theme.conf'"

      # Apply rio theme
      distrobox-host-exec bash -c "[ -f '$HOST_HOME/.config/rio/config.toml' ] && sed -i 's/^theme = .*/theme = \"$THEME\"/' '$HOST_HOME/.config/rio/config.toml'"

      # Apply GTK theme
      if [[ "$THEME" == *"mocha"* ]]; then
        distrobox-host-exec gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'
      else
        distrobox-host-exec gsettings set org.gnome.desktop.interface color-scheme 'prefer-light'
      fi

      # Save current theme
      distrobox-host-exec bash -c "mkdir -p '$HOST_HOME/.config/apparatus' && echo '$THEME' > '$HOST_HOME/.config/apparatus/current-theme'"

      # Reload services
      distrobox-host-exec hyprctl reload 2>/dev/null || true
      distrobox-host-exec pkill -SIGUSR1 kitty 2>/dev/null || true
      distrobox-host-exec makoctl reload 2>/dev/null || true

      echo '{{ Color "2" "✓ Theme applied" }}' | gum format -t template
      ;;
    Back|"")
      return
      ;;
  esac

  echo ""
  echo "Press any key to continue..."
  read -k 1
}

# Main
main
