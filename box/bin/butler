#!/usr/bin/env zsh
#set -x

logo='
   _____                                          __
  /  _  \  ______  ______ _____  _______ _____  _/  |_  __ __  ______
 /  /_\  \ \____ \ \____ \\__  \ \_  __ \\__  \ \   __\|  |  \/  ___/
/    |    \|  |_> >|  |_> >/ __ \_|  | \/ / __ \_|  |  |  |  /\___ \
\____|__  /|   __/ |   __/(____  /|__|   (____  /|__|  |____//____  >
        \/ |__|    |__|        \/             \/                  \/

'

echo -e "$logo"

# Available options
OPTIONS=(
  "Init              - Initialize a new Apparatus box"
  "Manage Tools      - Install and manage tools"
  "Manage Tools TUI  - Tool manager (enhanced UI)"
  "Theme             - Select a theme"
  "Exit              - Exit butler"
)

# -- Main func
main() {
  while true; do
    local OPT=$(gum choose "${OPTIONS[@]}" --height 15 --header "Option:")
    local CHOICE=$(echo "$OPT" | awk -F ' {2,}' '{print $1}' | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g')

    case "${CHOICE}" in
      init)
        init
        ;;
      manage-tools)
        manage_tools
        ;;
      manage-tools-tui)
        manage_tools_tui
        ;;
      theme)
        set_theme
        ;;
      exit|q|"")
        echo "Goodbye!"
        return
        ;;
    esac
  done
}

# -- Manage tools TUI (Bubbletea)
manage_tools_tui() {
  if command -v butler-tools &>/dev/null; then
    butler-tools
  else
    echo '{{ Color "1" "butler-tools not installed" }}' | gum format -t template
    echo "The enhanced TUI requires the butler-tools binary."
    echo ""
    echo "Press any key to continue..."
    read -k 1
  fi
}

# -- Run init script
init() {
  echo '{{ Bold "# Initialize Apparatus box" }}' | gum format -t template
  echo ""
  if gum confirm "Run initialization script?"; then
    /opt/bin/init.sh
    echo ""
    echo '{{ Color "2" "âœ“ Initialization complete" }}' | gum format -t template
  fi
  echo ""
  echo "Press any key to continue..."
  read -k 1
}

# -- Manage tools
# Tools are auto-discovered from /opt/bin/tool_<category>_<name>.sh

# Category icons
typeset -A CATEGORY_ICONS
CATEGORY_ICONS=(
  [cloud]="â˜ï¸ "
  [kubernetes]="âŽˆ "
  [development]="ðŸ”§"
)

get_categories() {
  ls /opt/bin/tool_*.sh 2>/dev/null | sed 's|.*/tool_||;s|_[^_]*\.sh$||' | sort -u
}

get_tools_for_category() {
  local category=$1
  ls /opt/bin/tool_${category}_*.sh 2>/dev/null | sed "s|.*/tool_${category}_||;s|\.sh$||"
}

get_all_tools() {
  ls /opt/bin/tool_*.sh 2>/dev/null | sed 's|.*/tool_[^_]*_||;s|\.sh$||'
}

get_tool_script() {
  local tool=$1
  ls /opt/bin/tool_*_${tool}.sh 2>/dev/null | head -1
}

manage_tools() {
  while true; do
    echo '{{ Bold "# Manage tools" }}' | gum format -t template

    # Build category menu dynamically
    local categories=($(get_categories))
    local category_menu=()

    for cat in "${categories[@]}"; do
      local count=$(get_tools_for_category "$cat" | wc -l)
      local icon="${CATEGORY_ICONS[$cat]:-ðŸ“¦}"
      # Capitalize category name
      local display_name="$(echo $cat | sed 's/./\U&/')"
      category_menu+=("${icon} ${display_name}|${cat}|${count}")
    done

    # Format menu items
    local menu_display=()
    for item in "${category_menu[@]}"; do
      local icon_name=$(echo "$item" | cut -d'|' -f1)
      local count=$(echo "$item" | cut -d'|' -f3)
      menu_display+=("${icon_name} (${count} tools)")
    done
    menu_display+=("ðŸ“‹ All tools")
    menu_display+=("Back             - Return to main menu")

    local CATEGORY=$(gum choose "${menu_display[@]}" --height 15 --header "Select category:")

    [[ "$CATEGORY" == "Back"* || -z "$CATEGORY" ]] && return

    # Get tools for selected category
    local TOOLS=()
    if [[ "$CATEGORY" == *"All tools"* ]]; then
      TOOLS=($(get_all_tools))
    else
      # Extract category key from selection
      local selected_cat=""
      for item in "${category_menu[@]}"; do
        local icon_name=$(echo "$item" | cut -d'|' -f1)
        if [[ "$CATEGORY" == "${icon_name}"* ]]; then
          selected_cat=$(echo "$item" | cut -d'|' -f2)
          break
        fi
      done
      TOOLS=($(get_tools_for_category "$selected_cat"))
    fi

    # Tool selection loop
    while true; do
      local TOOL=$(gum choose \
        "${TOOLS[@]}" \
        "â† Back           - Return to categories" \
        --height 15 --header "Select tool:")

      [[ "$TOOL" == "â†"* || -z "$TOOL" ]] && break

      # Get the actual script path for this tool
      local TOOL_SCRIPT=$(get_tool_script "$TOOL")

      # Action loop for selected tool
      while true; do
        local ACTION=$(gum choose \
          "latest           - Install latest version" \
          "enter version    - Install specific version" \
          "show available   - Show available versions" \
          "show current     - Show current version" \
          "set version      - Set active version" \
          "â† Back           - Return to tool selection" \
          --height 15 --header "Action for $TOOL:")

        local ACTION_KEY=$(echo "$ACTION" | awk -F ' {2,}' '{print $1}')

        case "$ACTION_KEY" in
          'show available')
            source "$TOOL_SCRIPT" available
            ;;
          'show current')
            source "$TOOL_SCRIPT" current
            ;;
          'latest')
            source "$TOOL_SCRIPT" latest
            ;;
          'enter version')
            VERSION=$(gum input --placeholder "Enter version (e.g. 1.2.1)")
            [[ -n "$VERSION" ]] && source "$TOOL_SCRIPT" install_version "$VERSION"
            ;;
          'set version')
            source "$TOOL_SCRIPT" setversion
            ;;
          'â†'*|'')
            break
            ;;
        esac

        echo ""
        echo "Press any key to continue..."
        read -k 1
      done
    done
  done
}

# -- Set theme
set_theme() {
  local THEMES_DIR="/usr/share/apparatus/themes"
  local HOST_HOME="$DISTROBOX_HOST_HOME"

  echo '{{ Bold "# Set theme" }}' | gum format -t template
  local CHOICE=$(gum choose \
    "catppuccin-mocha  - Dark theme" \
    "catppuccin-latte  - Light theme" \
    "Back              - Return to main menu" \
    --height 15 --header "Select theme:")

  local THEME=$(echo "$CHOICE" | awk -F ' {2,}' '{print $1}')

  case "$THEME" in
    catppuccin-mocha|catppuccin-latte)
      echo '{{ Bold "# Applying theme: " }}'"$THEME" | gum format -t template

      # Apply kitty theme
      distrobox-host-exec bash -c "[ -d '$HOST_HOME/.config/kitty' ] && ln -sf '$THEMES_DIR/$THEME/kitty.conf' '$HOST_HOME/.config/kitty/theme.conf'"

      # Apply waybar theme
      distrobox-host-exec bash -c "[ -d '$HOST_HOME/.config/waybar' ] && ln -sf '$THEMES_DIR/$THEME/waybar.css' '$HOST_HOME/.config/waybar/theme.css'"

      # Apply mako theme
      distrobox-host-exec bash -c "[ -d '$HOST_HOME/.config/mako' ] && ln -sf '$THEMES_DIR/$THEME/mako.conf' '$HOST_HOME/.config/mako/config'"

      # Apply hyprland theme
      distrobox-host-exec bash -c "[ -d '$HOST_HOME/.config/hypr' ] && ln -sf '$THEMES_DIR/$THEME/hyprland.conf' '$HOST_HOME/.config/hypr/theme.conf'"

      # Apply rio theme
      distrobox-host-exec bash -c "[ -f '$HOST_HOME/.config/rio/config.toml' ] && sed -i 's/^theme = .*/theme = \"$THEME\"/' '$HOST_HOME/.config/rio/config.toml'"

      # Apply GTK theme
      if [[ "$THEME" == *"mocha"* ]]; then
        distrobox-host-exec gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'
      else
        distrobox-host-exec gsettings set org.gnome.desktop.interface color-scheme 'prefer-light'
      fi

      # Save current theme
      distrobox-host-exec bash -c "mkdir -p '$HOST_HOME/.config/apparatus' && echo '$THEME' > '$HOST_HOME/.config/apparatus/current-theme'"

      # Reload services
      distrobox-host-exec hyprctl reload 2>/dev/null || true
      distrobox-host-exec pkill -SIGUSR1 kitty 2>/dev/null || true
      distrobox-host-exec makoctl reload 2>/dev/null || true

      echo '{{ Color "2" "âœ“ Theme applied" }}' | gum format -t template
      ;;
    Back|"")
      return
      ;;
  esac

  echo ""
  echo "Press any key to continue..."
  read -k 1
}

# Main
main
