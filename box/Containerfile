# Build stage for butler-tools
FROM docker.io/golang:1.22-alpine AS builder
WORKDIR /build
COPY box/cmd/butler-tools/ .
RUN go build -o butler-tools .

# Main image
FROM docker.io/fedora:43
LABEL com.github.containers.toolbox="true"

ARG VERSION_GUM="0.14.5"
ARG VERSION_NEOVIM="0.10.0"
ARG VERSION_MISE="2025.1.6"
ARG CHEZMOI_VERSION="2.52.2"

# -- Set zsh as default shell
ENV SHELL=/bin/zsh

# -- Packages
# fuse deps are needed to work with appimage. wget2-wget is needed to prevent installing packaes when starting distrobox https://github.com/89luca89/distrobox/issues/1734
RUN dnf install -y bash zsh fuse fuse-libs curl git unzip ripgrep bat wl-clipboard flatpak-spawn sudo gawk gcc gcc-c++ wget2-wget && \
    sed -i 's|SHELL=/bin/bash|SHELL=/bin/zsh|' /etc/default/useradd

## -- mise
RUN curl -L "https://github.com/jdx/mise/releases/download/v${VERSION_MISE}/mise-v${VERSION_MISE}-linux-x64" -o /usr/local/bin/mise && \
    chmod +x /usr/local/bin/mise

## -- Charm
RUN curl -OL https://github.com/charmbracelet/gum/releases/download/v${VERSION_GUM}/gum_${VERSION_GUM}_Linux_x86_64.tar.gz && \
  tar -C /usr/local/bin --strip-components=1 -xzf gum_${VERSION_GUM}_Linux_x86_64.tar.gz gum_${VERSION_GUM}_Linux_x86_64/gum && \
  rm gum_${VERSION_GUM}_Linux_x86_64.tar.gz

## -- NeoVim
RUN mkdir /opt/nvim && \
    curl -OL https://github.com/neovim/neovim/releases/download/v${VERSION_NEOVIM}/nvim.appimage && \
    mv nvim.appimage /opt/nvim && \
    chmod +x /opt/nvim/nvim.appimage

## -- Chezmoi
RUN curl -OL https://github.com/twpayne/chezmoi/releases/download/v${CHEZMOI_VERSION}/chezmoi_${CHEZMOI_VERSION}_linux_amd64.tar.gz && \
  tar -C /usr/local/bin -xzf "chezmoi_${CHEZMOI_VERSION}_linux_amd64.tar.gz"

## -- Environment variables
COPY box/system/profile-custom.sh /etc/profile.d/99-custom.sh

## -- Copy default configuration
COPY box/config/* /usr/share/apparatus/

## -- Scripts
COPY --chmod=0755 box/bin/ /opt/bin

## -- Butler tools TUI (from builder stage)
COPY --from=builder /build/butler-tools /usr/local/bin/butler-tools

## -- Host command symlinks (distrobox-host-exec)
RUN ln -sf /usr/bin/distrobox-host-exec /usr/local/bin/docker && \
    ln -sf /usr/bin/distrobox-host-exec /usr/local/bin/podman && \
    ln -sf /usr/bin/distrobox-host-exec /usr/local/bin/flatpak && \
    ln -sf /usr/bin/distrobox-host-exec /usr/bin/gsettings
