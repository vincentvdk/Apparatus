# Apparatus OS Session - 2026-01-04

## Summary
Added branding, tools, and fixed update infrastructure.

## Issue Resolved
- **USB creation issue**: diffid manifest error when writing ISO to USB stick
- **Root cause**: Stale state on the machine creating the USB stick
- **Fix**: Rebooting the machine and re-creating the USB stick resolved it

## What We Accomplished

### 1. GRUB/OS Branding - Fedora â†’ Apparatus
- **Custom `/etc/os-release`**: Created with Apparatus branding
- **Version from git hash**: Passed via `APPARATUS_VERSION` build arg
- **GRUB menu** now shows "Apparatus OS {git-hash}" instead of Fedora
- **Files changed**:
  - `os/Containerfile.bootc` - Added `APPARATUS_VERSION` build arg
  - `os/build_files/build.sh` - Creates custom `/etc/os-release`
  - `justfile` - Passes git hash to build
  - `.github/workflows/build.yml` - Passes git hash to build

### 2. Fixed Butler Auto-Start on Fresh Install
- **Problem**: systemd user service (`apparatus-first-login.service`) wasn't triggering
- **Root cause**: Dependency on `graphical-session.target` not reliable with UWSM
- **Fix**: Added `exec-once` in Hyprland config to run `/usr/libexec/apparatus/first-login.sh`
- **Files changed**:
  - `os/build_files/config/hypr/hyprland.conf` - Added exec-once for first-login

### 3. Network Configuration Tools
- **Added `nmtui`**: Terminal UI for NetworkManager (works before GUI)
- **Added `nm-applet`**: System tray icon for quick WiFi switching
- **nm-applet** added to Hyprland autostart
- **Files changed**:
  - `os/build_files/build.sh` - Added `NetworkManager-tui`
  - `os/build_files/config/hypr/hyprland.conf` - Added `exec-once = nm-applet`

### 4. Monitor/Display Configuration
- **Added `nwg-displays`**: Hyprland-aware display configuration tool
- Saves monitor config directly to hyprland.conf
- Added floating window rule
- **Files changed**:
  - `os/build_files/build.sh` - Added nwg-shell COPR and nwg-displays
  - `os/build_files/config/hypr/hyprland.conf` - Added window rule

### 5. Fixed rpm-ostree/bootc Updates
- **Problem**: After ISO install, updates pointed to `/run/install/repo/container`
- **Root cause**: Container wasn't being pushed to GHCR; install source was local
- **Fix (two-part)**:
  1. CI now pushes container to GHCR before building ISO
  2. First-login script runs `bootc switch` to point to GHCR registry
- **Files changed**:
  - `.github/workflows/build.yml` - Added GHCR login and push steps
  - `os/build_files/apparatus/first-login.sh` - Added bootc switch logic

## Key Files Modified
- `os/Containerfile.bootc` - Added APPARATUS_VERSION build arg
- `os/build_files/build.sh` - os-release, nmtui, nwg-displays
- `os/build_files/config/hypr/hyprland.conf` - exec-once for first-login, nm-applet, window rules
- `os/build_files/apparatus/first-login.sh` - bootc switch logic
- `.github/workflows/build.yml` - git hash version, GHCR push
- `justfile` - git hash version

## New Package Dependencies
- `NetworkManager-tui` - nmtui for terminal network config
- `nwg-displays` - Hyprland display configuration (from nwg-shell COPR)

## New COPRs
- `nwg-shell/nwg-shell` - For nwg-displays

## Commits
(pending)

## Status
- All changes ready for testing
- Need to build and test ISO

## Next Steps
- Build container and ISO locally with `just build-iso`
- Test fresh install on hardware
- Verify butler auto-start works
- Verify bootc switch runs successfully
- Verify nwg-displays and nmtui work
